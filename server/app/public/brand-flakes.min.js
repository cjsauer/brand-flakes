!function(t,e){"function"==typeof define&&define.amd?define(e):"object"==typeof exports?module.exports=e():t.DDP=e()}(this,function(){"use strict";var t=function(){var t=0;return function(){return(t++).toString()}}(),e='{"server_id":"0"}',n=10,o=300,r=1e4,i=["added","changed","connected","error","failed","nosub","ready","removed","result","updated","ping","pong"],s="1",c=function(t){this._endpoint=t.endpoint,this._SocketConstructor=t.SocketConstructor,this._autoreconnect=!t.do_not_autoreconnect,this._ping_interval=t._ping_interval||r,this._socketInterceptFunction=t.socketInterceptFunction,this._onReadyCallbacks={},this._onStopCallbacks={},this._onErrorCallbacks={},this._onResultCallbacks={},this._onUpdatedCallbacks={},this._events={},this._queue=[],this.readyState=-1,this._reconnect_count=0,this._reconnect_incremental_timer=0,t.do_not_autoconnect||this.connect()};return c.prototype.constructor=c,c.prototype.connect=function(){this.readyState=0,this._socket=new this._SocketConstructor(this._endpoint),this._socket.onopen=this._on_socket_open.bind(this),this._socket.onmessage=this._on_socket_message.bind(this),this._socket.onerror=this._on_socket_error.bind(this),this._socket.onclose=this._on_socket_close.bind(this)},c.prototype.method=function(e,n,o,r){var i=t();return this._onResultCallbacks[i]=o,this._onUpdatedCallbacks[i]=r,this._send({msg:"method",id:i,method:e,params:n}),i},c.prototype.sub=function(e,n,o,r,i){var s=t();return this._onReadyCallbacks[s]=o,this._onStopCallbacks[s]=r,this._onErrorCallbacks[s]=i,this._send({msg:"sub",id:s,name:e,params:n}),s},c.prototype.unsub=function(t){return this._send({msg:"unsub",id:t}),t},c.prototype.on=function(t,e){this._events[t]=this._events[t]||[],this._events[t].push(e)},c.prototype.off=function(t,e){if(this._events[t]){var n=this._events[t].indexOf(e);-1!==n&&this._events[t].splice(n,1)}},c.prototype._emit=function(t){if(this._events[t]){var e=arguments,n=this;this._events[t].forEach(function(t){t.apply(n,Array.prototype.slice.call(e,1))})}},c.prototype._send=function(t){if(1!==this.readyState&&"connect"!==t.msg)return void this._queue.push(t);var e;e="undefined"==typeof EJSON?JSON.stringify(t):EJSON.stringify(t),this._socketInterceptFunction&&this._socketInterceptFunction({type:"socket_message_sent",message:e,timestamp:Date.now()}),this._socket.send(e)},c.prototype._try_reconnect=function(){this._reconnect_count<n?(setTimeout(this.connect.bind(this),this._reconnect_incremental_timer),this._reconnect_count+=1,this._reconnect_incremental_timer+=o*this._reconnect_count):setTimeout(this.connect.bind(this),this._reconnect_incremental_timer)},c.prototype._on_result=function(t){if(this._onResultCallbacks[t.id])this._onResultCallbacks[t.id](t.error,t.result),delete this._onResultCallbacks[t.id],t.error&&delete this._onUpdatedCallbacks[t.id];else if(t.error)throw delete this._onUpdatedCallbacks[t.id],t.error},c.prototype._on_updated=function(t){var e=this;t.methods.forEach(function(t){e._onUpdatedCallbacks[t]&&(e._onUpdatedCallbacks[t](),delete e._onUpdatedCallbacks[t])})},c.prototype._on_nosub=function(t){if(t.error){if(!this._onErrorCallbacks[t.id])throw delete this._onReadyCallbacks[t.id],delete this._onStopCallbacks[t.id],new Error(t.error);return this._onErrorCallbacks[t.id](t.error),delete this._onReadyCallbacks[t.id],delete this._onStopCallbacks[t.id],void delete this._onErrorCallbacks[t.id]}this._onStopCallbacks[t.id]&&this._onStopCallbacks[t.id](),delete this._onReadyCallbacks[t.id],delete this._onStopCallbacks[t.id],delete this._onErrorCallbacks[t.id]},c.prototype._on_ready=function(t){var e=this;t.subs.forEach(function(t){e._onReadyCallbacks[t]&&(e._onReadyCallbacks[t](),delete e._onReadyCallbacks[t])})},c.prototype._on_error=function(t){this._emit("error",t)},c.prototype._on_connected=function(e){var n=this,o=0===n._reconnect_count,r=o?"connected":"reconnected";n.readyState=1,n._reconnect_count=0,n._reconnect_incremental_timer=0;for(var i=n._queue.length,s=0;i>s;s++)n._send(n._queue.shift());n._emit(r,e),n._ping_interval_handle=setInterval(function(){var e=t();n._send({msg:"ping",id:e})},n._ping_interval)},c.prototype._on_failed=function(t){this.readyState=4,this._emit("failed",t)},c.prototype._on_added=function(t){this._emit("added",t)},c.prototype._on_removed=function(t){this._emit("removed",t)},c.prototype._on_changed=function(t){this._emit("changed",t)},c.prototype._on_ping=function(t){this._send({msg:"pong",id:t.id})},c.prototype._on_pong=function(t){},c.prototype._on_socket_close=function(){this._socketInterceptFunction&&this._socketInterceptFunction({type:"socket_close",timestamp:Date.now()}),clearInterval(this._ping_interval_handle),this.readyState=4,this._emit("socket_close"),this._autoreconnect&&this._try_reconnect()},c.prototype._on_socket_error=function(t){this._socketInterceptFunction&&this._socketInterceptFunction({type:"socket_error",error:JSON.stringify(t),timestamp:Date.now()}),clearInterval(this._ping_interval_handle),this.readyState=4,this._emit("socket_error",t)},c.prototype._on_socket_open=function(){this._socketInterceptFunction&&this._socketInterceptFunction({type:"socket_open",timestamp:Date.now()}),this._send({msg:"connect",version:s,support:[s]})},c.prototype._on_socket_message=function(t){this._socketInterceptFunction&&this._socketInterceptFunction({type:"socket_message_received",message:t.data,timestamp:Date.now()});var n;if(t.data!==e){try{if(n="undefined"==typeof EJSON?JSON.parse(t.data):EJSON.parse(t.data),-1===i.indexOf(n.msg))throw new Error}catch(o){return console.warn("Non DDP message received:"),void console.warn(t.data)}this["_on_"+n.msg](n)}},c}),function(t){if("function"==typeof bootstrap)bootstrap("promise",t);else if("object"==typeof exports)module.exports=t();else if("function"==typeof define&&define.amd)define(t);else if("undefined"!=typeof ses){if(!ses.ok())return;ses.makeQ=t}else Q=t()}(function(){"use strict";function t(t){return function(){return z.apply(t,arguments)}}function e(t){return t===Object(t)}function n(t){return"[object StopIteration]"===et(t)||t instanceof q}function o(t,e){if(L&&e.stack&&"object"==typeof t&&null!==t&&t.stack&&-1===t.stack.indexOf(nt)){for(var n=[],o=e;o;o=o.source)o.stack&&n.unshift(o.stack);n.unshift(t.stack);var i=n.join("\n"+nt+"\n");t.stack=r(i)}}function r(t){for(var e=t.split("\n"),n=[],o=0;o<e.length;++o){var r=e[o];c(r)||i(r)||!r||n.push(r)}return n.join("\n")}function i(t){return-1!==t.indexOf("(module.js:")||-1!==t.indexOf("(node.js:")}function s(t){var e=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(t);if(e)return[e[1],Number(e[2])];var n=/at ([^ ]+):(\d+):(?:\d+)$/.exec(t);if(n)return[n[1],Number(n[2])];var o=/.*@(.+):(\d+)$/.exec(t);return o?[o[1],Number(o[2])]:void 0}function c(t){var e=s(t);if(!e)return!1;var n=e[0],o=e[1];return n===B&&o>=$&&st>=o}function u(){if(L)try{throw new Error}catch(t){var e=t.stack.split("\n"),n=e[0].indexOf("@")>0?e[1]:e[2],o=s(n);if(!o)return;return B=o[0],o[1]}}function a(t,e,n){return function(){return"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn(e+" is deprecated, use "+n+" instead.",new Error("").stack),t.apply(t,arguments)}}function l(t){return y(t)?t:v(t)?I(t):E(t)}function p(){function t(t){e=t,i.source=t,K(n,function(e,n){W(function(){t.promiseDispatch.apply(t,n)})},void 0),n=void 0,o=void 0}var e,n=[],o=[],r=Y(p.prototype),i=Y(h.prototype);if(i.promiseDispatch=function(t,r,i){var s=H(arguments);n?(n.push(s),"when"===r&&i[1]&&o.push(i[1])):W(function(){e.promiseDispatch.apply(e,s)})},i.valueOf=function(){if(n)return i;var t=m(e);return y(t)&&(e=t),t},i.inspect=function(){return e?e.inspect():{state:"pending"}},l.longStackSupport&&L)try{throw new Error}catch(s){i.stack=s.stack.substring(s.stack.indexOf("\n")+1)}return r.promise=i,r.resolve=function(n){e||t(l(n))},r.fulfill=function(n){e||t(E(n))},r.reject=function(n){e||t(C(n))},r.notify=function(t){e||K(o,function(e,n){W(function(){n(t)})},void 0)},r}function d(t){if("function"!=typeof t)throw new TypeError("resolver must be a function.");var e=p();try{t(e.resolve,e.reject,e.notify)}catch(n){e.reject(n)}return e.promise}function f(t){return d(function(e,n){for(var o=0,r=t.length;r>o;o++)l(t[o]).then(e,n)})}function h(t,e,n){void 0===e&&(e=function(t){return C(new Error("Promise does not support operation: "+t))}),void 0===n&&(n=function(){return{state:"unknown"}});var o=Y(h.prototype);if(o.promiseDispatch=function(n,r,i){var s;try{s=t[r]?t[r].apply(o,i):e.call(o,r,i)}catch(c){s=C(c)}n&&n(s)},o.inspect=n,n){var r=n();"rejected"===r.state&&(o.exception=r.reason),o.valueOf=function(){var t=n();return"pending"===t.state||"rejected"===t.state?o:t.value}}return o}function _(t,e,n,o){return l(t).then(e,n,o)}function m(t){if(y(t)){var e=t.inspect();if("fulfilled"===e.state)return e.value}return t}function y(t){return e(t)&&"function"==typeof t.promiseDispatch&&"function"==typeof t.inspect}function v(t){return e(t)&&"function"==typeof t.then}function g(t){return y(t)&&"pending"===t.inspect().state}function k(t){return!y(t)||"fulfilled"===t.inspect().state}function b(t){return y(t)&&"rejected"===t.inspect().state}function S(){ot.length=0,rt.length=0,it||(it=!0)}function w(t,e){it&&(rt.push(t),e&&"undefined"!=typeof e.stack?ot.push(e.stack):ot.push("(no stack) "+e))}function j(t){if(it){var e=G(rt,t);-1!==e&&(rt.splice(e,1),ot.splice(e,1))}}function C(t){var e=h({when:function(e){return e&&j(this),e?e(t):this}},function(){return this},function(){return{state:"rejected",reason:t}});return w(e,t),e}function E(t){return h({when:function(){return t},get:function(e){return t[e]},set:function(e,n){t[e]=n},"delete":function(e){delete t[e]},post:function(e,n){return null===e||void 0===e?t.apply(void 0,n):t[e].apply(t,n)},apply:function(e,n){return t.apply(e,n)},keys:function(){return tt(t)}},void 0,function(){return{state:"fulfilled",value:t}})}function I(t){var e=p();return W(function(){try{t.then(e.resolve,e.reject,e.notify)}catch(n){e.reject(n)}}),e.promise}function R(t){return h({isDef:function(){}},function(e,n){return A(t,e,n)},function(){return l(t).inspect()})}function O(t,e,n){return l(t).spread(e,n)}function T(t){return function(){function e(t,e){var s;if("undefined"==typeof StopIteration){try{s=o[t](e)}catch(c){return C(c)}return s.done?s.value:_(s.value,r,i)}try{s=o[t](e)}catch(c){return n(c)?c.value:C(c)}return _(s,r,i)}var o=t.apply(this,arguments),r=e.bind(e,"next"),i=e.bind(e,"throw");return r()}}function x(t){l.done(l.async(t)())}function F(t){throw new q(t)}function N(t){return function(){return O([this,Q(arguments)],function(e,n){return t.apply(e,n)})}}function A(t,e,n){return l(t).dispatch(e,n)}function Q(t){return _(t,function(t){var e=0,n=p();return K(t,function(o,r,i){var s;y(r)&&"fulfilled"===(s=r.inspect()).state?t[i]=s.value:(++e,_(r,function(o){t[i]=o,0===--e&&n.resolve(t)},n.reject,function(t){n.notify({index:i,value:t})}))},void 0),0===e&&n.resolve(t),n.promise})}function D(t){return _(t,function(t){return t=X(t,l),_(Q(X(t,function(t){return _(t,V,V)})),function(){return t})})}function U(t){return l(t).allSettled()}function P(t,e){return l(t).then(void 0,void 0,e)}function J(t,e){return l(t).nodeify(e)}var L=!1;try{throw new Error}catch(M){L=!!M.stack}var B,q,$=u(),V=function(){},W=function(){function t(){for(;e.next;){e=e.next;var n=e.task;e.task=void 0;var r=e.domain;r&&(e.domain=void 0,r.enter());try{n()}catch(s){if(i)throw r&&r.exit(),setTimeout(t,0),r&&r.enter(),s;setTimeout(function(){throw s},0)}r&&r.exit()}o=!1}var e={task:void 0,next:null},n=e,o=!1,r=void 0,i=!1;if(W=function(t){n=n.next={task:t,domain:i&&process.domain,next:null},o||(o=!0,r())},"undefined"!=typeof process&&process.nextTick)i=!0,r=function(){process.nextTick(t)};else if("function"==typeof setImmediate)r="undefined"!=typeof window?setImmediate.bind(window,t):function(){setImmediate(t)};else if("undefined"!=typeof MessageChannel){var s=new MessageChannel;s.port1.onmessage=function(){r=c,s.port1.onmessage=t,t()};var c=function(){s.port2.postMessage(0)};r=function(){setTimeout(t,0),c()}}else r=function(){setTimeout(t,0)};return W}(),z=Function.call,H=t(Array.prototype.slice),K=t(Array.prototype.reduce||function(t,e){var n=0,o=this.length;if(1===arguments.length)for(;;){if(n in this){e=this[n++];break}if(++n>=o)throw new TypeError}for(;o>n;n++)n in this&&(e=t(e,this[n],n));return e}),G=t(Array.prototype.indexOf||function(t){for(var e=0;e<this.length;e++)if(this[e]===t)return e;return-1}),X=t(Array.prototype.map||function(t,e){var n=this,o=[];return K(n,function(r,i,s){o.push(t.call(e,i,s,n))},void 0),o}),Y=Object.create||function(t){function e(){}return e.prototype=t,new e},Z=t(Object.prototype.hasOwnProperty),tt=Object.keys||function(t){var e=[];for(var n in t)Z(t,n)&&e.push(n);return e},et=t(Object.prototype.toString);q="undefined"!=typeof ReturnValue?ReturnValue:function(t){this.value=t};var nt="From previous event:";l.resolve=l,l.nextTick=W,l.longStackSupport=!1,l.defer=p,p.prototype.makeNodeResolver=function(){var t=this;return function(e,n){e?t.reject(e):arguments.length>2?t.resolve(H(arguments,1)):t.resolve(n)}},l.Promise=d,l.promise=d,d.race=f,d.all=Q,d.reject=C,d.resolve=l,l.passByCopy=function(t){return t},h.prototype.passByCopy=function(){return this},l.join=function(t,e){return l(t).join(e)},h.prototype.join=function(t){return l([this,t]).spread(function(t,e){if(t===e)return t;throw new Error("Can't join: not the same: "+t+" "+e)})},l.race=f,h.prototype.race=function(){return this.then(l.race)},l.makePromise=h,h.prototype.toString=function(){return"[object Promise]"},h.prototype.then=function(t,e,n){function r(e){try{return"function"==typeof t?t(e):e}catch(n){return C(n)}}function i(t){if("function"==typeof e){o(t,c);try{return e(t)}catch(n){return C(n)}}return C(t)}function s(t){return"function"==typeof n?n(t):t}var c=this,u=p(),a=!1;return W(function(){c.promiseDispatch(function(t){a||(a=!0,u.resolve(r(t)))},"when",[function(t){a||(a=!0,u.resolve(i(t)))}])}),c.promiseDispatch(void 0,"when",[void 0,function(t){var e,n=!1;try{e=s(t)}catch(o){if(n=!0,!l.onerror)throw o;l.onerror(o)}n||u.notify(e)}]),u.promise},l.when=_,h.prototype.thenResolve=function(t){return this.then(function(){return t})},l.thenResolve=function(t,e){return l(t).thenResolve(e)},h.prototype.thenReject=function(t){return this.then(function(){throw t})},l.thenReject=function(t,e){return l(t).thenReject(e)},l.nearer=m,l.isPromise=y,l.isPromiseAlike=v,l.isPending=g,h.prototype.isPending=function(){return"pending"===this.inspect().state},l.isFulfilled=k,h.prototype.isFulfilled=function(){return"fulfilled"===this.inspect().state},l.isRejected=b,h.prototype.isRejected=function(){return"rejected"===this.inspect().state};var ot=[],rt=[],it=!0;l.resetUnhandledRejections=S,l.getUnhandledReasons=function(){return ot.slice()},l.stopUnhandledRejectionTracking=function(){S(),it=!1},S(),l.reject=C,l.fulfill=E,l.master=R,l.spread=O,h.prototype.spread=function(t,e){return this.all().then(function(e){return t.apply(void 0,e)},e)},l.async=T,l.spawn=x,l["return"]=F,l.promised=N,l.dispatch=A,h.prototype.dispatch=function(t,e){var n=this,o=p();return W(function(){n.promiseDispatch(o.resolve,t,e)}),o.promise},l.get=function(t,e){return l(t).dispatch("get",[e])},h.prototype.get=function(t){return this.dispatch("get",[t])},l.set=function(t,e,n){return l(t).dispatch("set",[e,n])},h.prototype.set=function(t,e){return this.dispatch("set",[t,e])},l.del=l["delete"]=function(t,e){return l(t).dispatch("delete",[e])},h.prototype.del=h.prototype["delete"]=function(t){return this.dispatch("delete",[t])},l.mapply=l.post=function(t,e,n){return l(t).dispatch("post",[e,n])},h.prototype.mapply=h.prototype.post=function(t,e){return this.dispatch("post",[t,e])},l.send=l.mcall=l.invoke=function(t,e){return l(t).dispatch("post",[e,H(arguments,2)])},h.prototype.send=h.prototype.mcall=h.prototype.invoke=function(t){return this.dispatch("post",[t,H(arguments,1)])},l.fapply=function(t,e){return l(t).dispatch("apply",[void 0,e])},h.prototype.fapply=function(t){return this.dispatch("apply",[void 0,t])},l["try"]=l.fcall=function(t){return l(t).dispatch("apply",[void 0,H(arguments,1)])},h.prototype.fcall=function(){return this.dispatch("apply",[void 0,H(arguments)])},l.fbind=function(t){var e=l(t),n=H(arguments,1);return function(){return e.dispatch("apply",[this,n.concat(H(arguments))])}},h.prototype.fbind=function(){var t=this,e=H(arguments);return function(){return t.dispatch("apply",[this,e.concat(H(arguments))])}},l.keys=function(t){return l(t).dispatch("keys",[])},h.prototype.keys=function(){return this.dispatch("keys",[])},l.all=Q,h.prototype.all=function(){return Q(this)},l.allResolved=a(D,"allResolved","allSettled"),h.prototype.allResolved=function(){return D(this)},l.allSettled=U,h.prototype.allSettled=function(){return this.then(function(t){return Q(X(t,function(t){function e(){return t.inspect()}return t=l(t),t.then(e,e)}))})},l.fail=l["catch"]=function(t,e){return l(t).then(void 0,e)},h.prototype.fail=h.prototype["catch"]=function(t){return this.then(void 0,t)},l.progress=P,h.prototype.progress=function(t){return this.then(void 0,void 0,t)},l.fin=l["finally"]=function(t,e){return l(t)["finally"](e)},h.prototype.fin=h.prototype["finally"]=function(t){return t=l(t),this.then(function(e){return t.fcall().then(function(){return e})},function(e){return t.fcall().then(function(){throw e})})},l.done=function(t,e,n,o){return l(t).done(e,n,o)},h.prototype.done=function(t,e,n){var r=function(t){W(function(){if(o(t,i),!l.onerror)throw t;l.onerror(t)})},i=t||e||n?this.then(t,e,n):this;"object"==typeof process&&process&&process.domain&&(r=process.domain.bind(r)),i.then(void 0,r)},l.timeout=function(t,e,n){return l(t).timeout(e,n)},h.prototype.timeout=function(t,e){var n=p(),o=setTimeout(function(){n.reject(new Error(e||"Timed out after "+t+" ms"))},t);return this.then(function(t){clearTimeout(o),n.resolve(t)},function(t){clearTimeout(o),n.reject(t)},n.notify),n.promise},l.delay=function(t,e){return void 0===e&&(e=t,t=void 0),l(t).delay(e)},h.prototype.delay=function(t){return this.then(function(e){var n=p();return setTimeout(function(){n.resolve(e)},t),n.promise})},l.nfapply=function(t,e){return l(t).nfapply(e)},h.prototype.nfapply=function(t){var e=p(),n=H(t);return n.push(e.makeNodeResolver()),this.fapply(n).fail(e.reject),e.promise},l.nfcall=function(t){var e=H(arguments,1);return l(t).nfapply(e)},h.prototype.nfcall=function(){var t=H(arguments),e=p();return t.push(e.makeNodeResolver()),this.fapply(t).fail(e.reject),e.promise},l.nfbind=l.denodeify=function(t){var e=H(arguments,1);return function(){var n=e.concat(H(arguments)),o=p();return n.push(o.makeNodeResolver()),l(t).fapply(n).fail(o.reject),o.promise}},h.prototype.nfbind=h.prototype.denodeify=function(){var t=H(arguments);return t.unshift(this),l.denodeify.apply(void 0,t)},l.nbind=function(t,e){var n=H(arguments,2);return function(){function o(){return t.apply(e,arguments)}var r=n.concat(H(arguments)),i=p();return r.push(i.makeNodeResolver()),l(o).fapply(r).fail(i.reject),i.promise}},h.prototype.nbind=function(){var t=H(arguments,0);return t.unshift(this),l.nbind.apply(void 0,t)},l.nmapply=l.npost=function(t,e,n){return l(t).npost(e,n)},h.prototype.nmapply=h.prototype.npost=function(t,e){var n=H(e||[]),o=p();return n.push(o.makeNodeResolver()),this.dispatch("post",[t,n]).fail(o.reject),o.promise},l.nsend=l.nmcall=l.ninvoke=function(t,e){var n=H(arguments,2),o=p();return n.push(o.makeNodeResolver()),l(t).dispatch("post",[e,n]).fail(o.reject),o.promise},h.prototype.nsend=h.prototype.nmcall=h.prototype.ninvoke=function(t){var e=H(arguments,1),n=p();return e.push(n.makeNodeResolver()),this.dispatch("post",[t,e]).fail(n.reject),n.promise},l.nodeify=J,h.prototype.nodeify=function(t){return t?void this.then(function(e){W(function(){t(null,e)})},function(e){W(function(){t(e)})}):this};var st=u();return l}),function(t,e){"function"==typeof define&&define.amd?define(e):"object"==typeof exports?module.exports=e():t.Asteroid=e()}(this,function(){"use strict";var t=function(e,n,o,r){t.utils.must.beString(e),this._instanceId=r||"0",this._host=(n?"https://":"http://")+e,this.collections={},this.subscriptions={},this._subscriptionsCache={},this._setDdpOptions(e,n,o),this._init()};t.utils||(t.utils={}),t.utils.btoa=function(){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",e=function(e){return t.charAt(e)},n=function(t){for(var e=[],n=0;t>n;n++)e.push(0);return e};return function(t){if("string"==typeof t){var o=t;t=n(o.length);for(var r=0;r<o.length;r++){var i=o.charCodeAt(r);if(i>255)throw new Error("Not ascii. Base64.encode can only take ascii strings");t[r]=i}}for(var s=[],c=null,u=null,a=null,l=null,p=0;p<t.length;p++)switch(p%3){case 0:c=t[p]>>2&63,u=(3&t[p])<<4;break;case 1:u|=t[p]>>4&15,a=(15&t[p])<<2;break;case 2:a|=t[p]>>6&3,l=63&t[p],s.push(e(c)),s.push(e(u)),s.push(e(a)),s.push(e(l)),c=null,u=null,a=null,l=null}return null!==c&&(s.push(e(c)),s.push(e(u)),null===a?s.push("="):s.push(e(a)),null===l&&s.push("=")),s.join("")}}(),t.utils||(t.utils={}),t.utils.clone=function(t){if("undefined"!=typeof EJSON)return EJSON.clone(t);var e=typeof t;switch(e){case"undefined":case"function":return;case"string":case"number":case"boolean":return t;case"object":return null===t?null:JSON.parse(JSON.stringify(t));default:return}},t.utils||(t.utils={}),t.utils.EventEmitter=function(){},t.utils.EventEmitter.prototype={constructor:t.utils.EventEmitter,on:function(t,e){this._events||(this._events={}),this._events[t]=this._events[t]||[],this._events[t].push(e)},off:function(t,e){this._events||(this._events={}),this._events[t]&&this._events[t].splice(this._events[t].indexOf(e),1)},_emit:function(t){if(this._events||(this._events={}),this._events[t]){var e=arguments,n=this;this._events[t].forEach(function(t){t.apply(n,Array.prototype.slice.call(e,1))})}}},t.utils||(t.utils={}),t.utils.getFilterFromSelector=function(e){var n=function(t,e){return e.split(".").reduce(function(t,e){return t?t=t[e]:t},t)},r=Object.keys(e),i=r.map(function(o){var r;return"$and"===o?(r=e[o].map(t.utils.getFilterFromSelector),function(t){return r.reduce(function(e,n){return e?n(t):e},!0)}):"$or"===o?(r=e[o].map(t.utils.getFilterFromSelector),function(t){return r.reduce(function(e,n){return e?e:n(t)},!1)}):"$nor"===o?(r=e[o].map(t.utils.getFilterFromSelector),function(t){return r.reduce(function(e,n){return e?!n(t):e},!0)}):function(t){var r=n(t,o);return r===e[o]}});return function(t){return t._id&&o(t._id)?!1:i.reduce(function(e,n){return e?n(t):e},!0)}},t.utils||(t.utils={}),t.utils.formQs=function(t){var e="";for(var n in t)t.hasOwnProperty(n)&&(e+=encodeURIComponent(n)+"="+encodeURIComponent(t[n])+"&");return e=e.slice(0,-1)},t.utils||(t.utils={}),t.utils.getOauthState=function(e){var n={loginStyle:"popup",credentialToken:e,isCordova:!1};return t.utils.btoa(JSON.stringify(n))},t.utils||(t.utils={}),t.utils.guid=function(){for(var t="",e=0;8>e;e++)t+=Math.floor(65536*(1+Math.random())).toString(16).substring(1);return t},t.utils||(t.utils={}),t.utils.isEmail=function(t){return-1!==t.indexOf("@")},t.utils||(t.utils={}),t.utils.isEqual=function(t,e){var n=JSON.stringify(t),o=JSON.stringify(e);return n===o},t.utils||(t.utils={}),t.utils.multiStorage={},t.utils||(t.utils={}),t.utils.must={_toString:function(t){return Object.prototype.toString.call(t).slice(8,-1)},beString:function(t){var e=this._toString(t);if("String"!==e)throw new Error("Assertion failed: expected String, instead got "+e)},beArray:function(t){var e=this._toString(t);if("Array"!==e)throw new Error("Assertion failed: expected Array, instead got "+e)},beObject:function(t){var e=this._toString(t);if("Object"!==e)throw new Error("Assertion failed: expected Object, instead got "+e)}},t.prototype=Object.create(t.utils.EventEmitter.prototype),t.prototype.constructor=t,t.prototype._init=function(){var t=this;t.ddp=new DDP(this._ddpOptions),t.ddp.on("connected",function(){t.resumeLoginPromise=t._tryResumeLogin(),t.subscribe("meteor.loginServiceConfiguration"),t._emit("connected")}),t.ddp.on("reconnected",function(){t.resumeLoginPromise=t._tryResumeLogin(),t._reEstablishSubscriptions(),t._emit("reconnected")}),t.ddp.on("added",function(e){t._onAdded(e)}),t.ddp.on("changed",function(e){t._onChanged(e)}),t.ddp.on("removed",function(e){t._onRemoved(e)})},t.prototype._onAdded=function(e){var n=e.collection;this.collections[n]||(this.collections[n]=new t._Collection(n,this));var o=e.fields||{};o._id=e.id,this.collections[n]._remoteToLocalInsert(o)},t.prototype._onRemoved=function(t){this.collections[t.collection]&&this.collections[t.collection]._remoteToLocalRemove(t.id)},t.prototype._onChanged=function(t){this.collections[t.collection]&&(t.fields||(t.fields={}),t.cleared&&t.cleared.forEach(function(e){t.fields[e]=void 0}),this.collections[t.collection]._remoteToLocalUpdate(t.id,t.fields))},t.prototype.call=function(e){t.utils.must.beString(e);var n=Array.prototype.slice.call(arguments,1);return this.apply(e,n)},t.prototype.apply=function(e,n){t.utils.must.beString(e),Array.isArray(n)||(n=[]);var o=Q.defer(),r=Q.defer(),i=function(t,e){t?(o.reject(t),r.reject()):o.resolve(e)},s=function(){r.resolve()};return this.ddp.method(e,n,i,s),{result:o.promise,updated:r.promise}},t.prototype.getCollection=function(e){return t.utils.must.beString(e),this.collections[e]||(this.collections[e]=new t._Collection(e,this)),this.collections[e]};var e="__del__",n="__upd__",o=function(t){var o=e.length,r=n.length,i=t.slice(-1*o),s=t.slice(-1*r);return i===e||s===n},r=function(t,e){this.name=t,this.asteroid=e,this._set=new s};r.prototype.constructor=r,r.prototype._localToLocalInsert=function(t){if(this._set.contains(t._id))throw new Error("Item "+t._id+" already exists");return this._set.put(t._id,t),Q(t._id)},r.prototype._remoteToLocalInsert=function(t){this._set.put(t._id,t)},r.prototype._localToRemoteInsert=function(t){var e=this,n=Q.defer(),o="/"+e.name+"/insert";return e.asteroid.ddp.method(o,[t],function(o,r){o?(e._set.del(t._id),n.reject(o)):n.resolve(t._id)}),n.promise},r.prototype.insert=function(e){return e._id||(e._id=t.utils.guid()),{local:this._localToLocalInsert(e),remote:this._localToRemoteInsert(e)}},r.prototype._localToLocalRemove=function(t){var n=this._set.get(t);return n&&(this._set.put(t+e,n),this._set.del(t)),Q(t)},r.prototype._remoteToLocalRemove=function(t){this._set.del(t)},r.prototype._localToRemoteRemove=function(t){var n=this,o=Q.defer(),r="/"+n.name+"/remove";return n.asteroid.ddp.method(r,[{_id:t}],function(r,i){if(r){var s=n._set.get(t+e);s&&(n._set.put(t,s),n._set.del(t+e)),o.reject(r)}else n._set.del(t+e),o.resolve(t)}),o.promise},r.prototype.remove=function(t){return{local:this._localToLocalRemove(t),remote:this._localToRemoteRemove(t)}},r.prototype._localToLocalUpdate=function(t,e){var o=this._set.get(t);if(!o)throw new Error("Item "+t+" doesn't exist");if(e._id&&e._id!==t)throw new Error("Modifying the _id of a document is not allowed");this._set.put(t+n,o);for(var r in e)e.hasOwnProperty(r)&&(o[r]=e[r]);return this._set.put(t,o),Q(t)},r.prototype._remoteToLocalUpdate=function(t,e){var n=this._set.get(t);if(!n)return void console.warn("Server misbehaviour: item "+t+" doesn't exist");for(var o in e){if("_id"===o&&e._id!==t)return void console.warn("Server misbehaviour: modifying the _id of a document is not allowed");n[o]=e[o]}this._set.put(t,n)},r.prototype._localToRemoteUpdate=function(t,e){var o=this,r=Q.defer(),i="/"+o.name+"/update",s={_id:t},c={$set:e};return o.asteroid.ddp.method(i,[s,c],function(e,i){if(e){var s=o._set.get(t+n);o._set.put(t,s),o._set.del(t+n),r.reject(e)}else o._set.del(t+n),r.resolve(t)}),r.promise},r.prototype.update=function(t,e){return{local:this._localToLocalUpdate(t,e),remote:this._localToRemoteUpdate(t,e)}};var i=function(t){var e=this;e.result=[],e._set=t,e._getResult(),e._set.on("put",function(t){e._getResult(),e._emit("change",t)}),e._set.on("del",function(t){e._getResult(),e._emit("change",t)})};i.prototype=Object.create(t.utils.EventEmitter.prototype),i.constructor=i,i.prototype._getResult=function(){this.result=this._set.toArray()},r.prototype.reactiveQuery=function(e){var n;n="function"==typeof e?e:t.utils.getFilterFromSelector(e);var o=this._set.filter(n);return new i(o)},t._Collection=r,t.prototype._getOauthClientId=function(t){var e="meteor_accounts_loginServiceConfiguration",n=this.collections[e],o=n.reactiveQuery({service:t}).result[0];return o.clientId||o.consumerKey||o.appId},t.prototype._loginAfterCredentialSecretReceived=function(e){var n=this,o=Q.defer(),r={oauth:e};return n.ddp.method("login",[r],function(e,r){e?(delete n.userId,delete n.loggedIn,t.utils.multiStorage.del(n._host+"__"+n._instanceId+"__login_token__"),o.reject(e),n._emit("loginError",e)):(n.userId=r.id,n.loggedIn=!0,t.utils.multiStorage.set(n._host+"__"+n._instanceId+"__login_token__",r.token),n._emit("login",r.id),o.resolve(r.id))}),o.promise},t.prototype._connectAfterCredentialSecretReceived=function(t){var e=Q.defer(),n={oauth:t};return this.ddp.method("addLoginService",[n],function(t,n){t?e.reject(t):e.resolve()}),e.promise},t.prototype._tryResumeLogin=function(){var e=this;return Q().then(function(){return t.utils.multiStorage.get(e._host+"__"+e._instanceId+"__login_token__")}).then(function(t){if(!t)throw new Error("No login token");return t}).then(function(n){var o=Q.defer(),r={resume:n};return e.ddp.method("login",[r],function(n,r){n?(delete e.userId,delete e.loggedIn,t.utils.multiStorage.del(e._host+"__"+e._instanceId+"__login_token__"),e._emit("loginError",n),o.reject(n)):(e.userId=r.id,e.loggedIn=!0,t.utils.multiStorage.set(e._host+"__"+e._instanceId+"__login_token__",r.token),e._emit("login",r.id),o.resolve(r.id))}),o.promise})},t.prototype.createUser=function(e,n,o){var r,i=this,s=Q.defer();return"string"==typeof e?r={username:t.utils.isEmail(e)?void 0:e,email:t.utils.isEmail(e)?e:void 0,password:n,profile:o}:"object"==typeof e&&(r=e),i.ddp.method("createUser",[r],function(e,n){e?(i._emit("createUserError",e),s.reject(e)):(i.userId=n.id,i.loggedIn=!0,t.utils.multiStorage.set(i._host+"__"+i._instanceId+"__login_token__",n.token),i._emit("createUser",n.id),i._emit("login",n.id),s.resolve(n.id))}),s.promise},t.prototype.loginWithPassword=function(e,n){var o=this,r=Q.defer(),i={password:n,user:{username:t.utils.isEmail(e)?void 0:e,email:t.utils.isEmail(e)?e:void 0}};return o.ddp.method("login",[i],function(e,n){e?(delete o.userId,delete o.loggedIn,t.utils.multiStorage.del(o._host+"__"+o._instanceId+"__login_token__"),r.reject(e),o._emit("loginError",e)):(o.userId=n.id,o.loggedIn=!0,t.utils.multiStorage.set(o._host+"__"+o._instanceId+"__login_token__",n.token),o._emit("login",n.id),r.resolve(n.id))}),r.promise},t.prototype.logout=function(){var e=this,n=Q.defer();return e.ddp.method("logout",[],function(o){o?(e._emit("logoutError",o),n.reject(o)):(delete e.userId,delete e.loggedIn,t.utils.multiStorage.del(e._host+"__"+e._instanceId+"__login_token__"),e._emit("logout"),n.resolve())}),n.promise};var s=function(t){t&&(this._put=this.put,this._del=this.del,this.put=this.del=function(){throw new Error("Attempt to modify readonly set")}),this._items={}};s.prototype=Object.create(t.utils.EventEmitter.prototype),s.constructor=s,s.prototype.put=function(e,n){return t.utils.must.beString(e),t.utils.must.beObject(n),this._items[e]=t.utils.clone(n),this._emit("put",e),this},s.prototype.del=function(e){return t.utils.must.beString(e),delete this._items[e],this._emit("del",e),this},s.prototype.get=function(e){return t.utils.must.beString(e),t.utils.clone(this._items[e])},s.prototype.contains=function(e){return t.utils.must.beString(e),!!this._items[e]},s.prototype.filter=function(e){var n=new s(!0),o=this._items,r=Object.keys(o);return r.forEach(function(r){var i=t.utils.clone(o[r]),s=e(i);s&&(n._items[r]=o[r])}),this.on("put",function(r){var i=t.utils.clone(o[r]),s=e(i);s&&n._put(r,o[r])}),this.on("del",function(t){n._del(t);
}),n},s.prototype.toArray=function(){var e=[],n=this._items,o=Object.keys(this._items);return o.forEach(function(t){e.push(n[t])}),t.utils.clone(e)},s.prototype.toHash=function(){return t.utils.clone(this._items)},t.Set=s;var c=function(t,e,n,o){this._name=t,this._params=e,this._fingerprint=n,this._asteroid=o,this._ready=Q.defer(),this.ready=this._ready.promise;var r=this._onReady.bind(this),i=this._onStop.bind(this),s=this._onError.bind(this);this.id=o.ddp.sub(t,e,r,i,s)};return c.constructor=c,c.prototype.stop=function(){this._asteroid.ddp.unsub(this.id),delete this._asteroid._subscriptionsCache[this._fingerprint]},c.prototype._onReady=function(){this._ready.resolve(this.id)},c.prototype._onStop=function(){delete this._asteroid.subscriptions[this.id],delete this._asteroid._subscriptionsCache[this._fingerprint]},c.prototype._onError=function(t){this.ready.isPending()&&this._ready.reject(t),delete this._asteroid.subscriptions[this.id],delete this._asteroid._subscriptionsCache[this._fingerprint]},t.prototype.subscribe=function(e){t.utils.must.beString(e);var n=Array.prototype.slice.call(arguments),o=JSON.stringify(n);if(!this._subscriptionsCache[o]){var r=n.slice(1),i=new c(e,r,o,this);this._subscriptionsCache[i._fingerprint]=i,this.subscriptions[i.id]=i}return this._subscriptionsCache[o]},t.prototype._reEstablishSubscriptions=function(){var t,e,n=this.subscriptions;for(var o in n)n.hasOwnProperty(o)&&(t=n[o],e=new c(t._name,t._params,t._fingerprint,this),delete this.subscriptions[t.id],delete this._subscriptionsCache[t._fingerprint],this.subscriptions[e.id]=e,this._subscriptionsCache[e._fingerprint]=e)},t.prototype._openOauthPopup=function(t,e,n){var o=this,r=window.open(e,"_blank","location=no,toolbar=no");r.focus&&r.focus();var i=Q.defer(),s=JSON.stringify({credentialToken:t}),c=setInterval(function(){r.postMessage(s,o._host)},100);return window.addEventListener("message",function(e){var n;try{n=JSON.parse(e.data)}catch(r){return}e.origin===o._host&&(n.credentialToken===t&&(clearInterval(c),i.resolve({credentialToken:n.credentialToken,credentialSecret:n.credentialSecret})),n.error&&(clearInterval(c),i.reject(n.error)))}),i.promise.then(n.bind(o))},t.utils.multiStorage.get=function(t){var e=Q.defer();return e.resolve(localStorage[t]),e.promise},t.utils.multiStorage.set=function(t,e){var n=Q.defer();return localStorage[t]=e,n.resolve(),n.promise},t.utils.multiStorage.del=function(t){var e=Q.defer();return delete localStorage[t],e.resolve(),e.promise},t.prototype._setDdpOptions=function(t,e,n){"function"==typeof SockJS?this._ddpOptions={endpoint:(e?"https://":"http://")+t+"/sockjs",SocketConstructor:SockJS,socketInterceptFunction:n}:this._ddpOptions={endpoint:(e?"wss://":"ws://")+t+"/websocket",SocketConstructor:WebSocket,socketInterceptFunction:n}},t}),function(){var t,e,n,o,r=!1,i=function(t){console.log("[Brand Flakes] "+t)},s=function(){if(r)throw new Error("Brand Flakes has already been initialized");var s=BrandFlakes.q.pop();t=s[0],e=s[1],n=!!s[2];var u;u=Meteor&&Meteor.settings["public"].brandFlakes?Meteor.settings["public"].brandFlakes.meteorServer:BrandFlakes.host,n&&i("Connecting to server at "+u),o=new Asteroid(u),n&&o.ddp.on("socket_close",function(){i("Connection to Brand Flakes server closed")}),o.ddp._autoreconnect=!1,n&&i("Authenticating app with appId: "+t),c(),r=!0},c=function(){if(r)throw new Error("Brand Flakes has already been authenticated");o.call("apps/authenticate",t).result.then(function(t){n&&i("Authentication successful!")})["catch"](function(t){o.ddp._socket.close(),console.error(t)})};s()}();